import{an as W,U as X,r as o,Q as j,Y as Z,a as ee,E as te,o as ae,_ as n,$ as oe,a0 as C,a5 as l,a6 as u,a4 as a,a9 as S,H as se,at as re,a1 as R,a2 as ne,av as ie,a3 as I,au as ce,aB as le,aC as ue}from"./index.47a28144.js";import{Q as de}from"./QPage.1664443c.js";import{B as i,G as q,_ as me}from"./index.a4168823.js";import{C as ve,a as pe,b as ge,c as _e}from"./index.6c2dd6cd.js";import{D as fe}from"./index.c22a573d.js";import{u as he,a as we,o as ye}from"./use-quasar.3a6fa932.js";import"./axios.66614422.js";const d=_=>(le("data-v-5aab067a"),_=_(),ue(),_),xe=d(()=>a("div",{class:"sample-background"},null,-1)),be={key:0,class:"container"},ke=d(()=>a("div",{class:"barcode-scanner--area--container"},[a("div",{class:"relative"},[a("p",null,"Apunta tu c\xE1mara al c\xF3digo QR")]),a("div",{class:"square surround-cover"},[a("div",{class:"barcode-scanner--area--outer surround-cover"},[a("div",{class:"barcode-scanner--area--inner"})])])],-1)),Ce=[ke],Se={key:1,class:"row text-uppercase text-grey-8 justify-center items-center content-center q-pa-md text-center",style:{"font-family":"'Bebas Neue'"}},Re=d(()=>a("div",null,"Registrar Entrada",-1)),Ee=[Re],Pe={class:"column justify-center items-center content-center"},De={key:0,class:"col-12 text-center q-pt-md"},Be=d(()=>a("img",{alt:"QR code",src:me,style:{width:"340px"}},null,-1)),Ne=[Be],Fe={key:1,class:"col-12"},Ae=["src"],Qe={class:"row justify-center q-pt-lg"},Le={class:"col text-center"},je={key:0,class:"text-subtitle2 text-grey-9"},Ie={key:0},qe={key:2,class:"q-pa-md row justify-center items-start q-gutter-md"},Te=d(()=>a("strong",null,"Hora de entrada: ",-1)),Oe=d(()=>a("br",null,null,-1)),Ue=d(()=>a("strong",null,"Lugar de trabajo: ",-1)),f=30,Ve=X({__name:"RegistroAsistenciaPage",setup(_){const h=o(""),E=o(),P=o(""),T=o(""),w=o(0),m=he(),y=o(!1),D=o(!1),B=o(!1),x=o(""),c=o(!1),r=o(!1),{get:N,post:F}=we();let O=new Date().toLocaleTimeString();const v=o({latitude:0,longitude:0,timestamp:0});j(()=>{const t=Z.getItem("session");w.value=(t==null?void 0:t.codigo)||0});const U=async(t,e)=>{try{const s=new FormData;s.append("file",t);const k=`/comparar_fotos/${e}`,g=await F(k,{},s);return m.notify({color:g.error==="N"?"green-4":"red-5",textColor:"white",icon:g.error==="N"?"cloud_done":"warning",message:g.mensaje,timeout:1e4}),g}catch(s){console.error("[ERROR AL SUBIR LA FOTO]:",s)}},V=async()=>{try{const t=await ve.getPhoto({quality:90,allowEditing:!1,resultType:pe.Uri,source:ge.Camera,direction:_e.Front,width:1024,height:768});if(t.webPath){E.value=t.webPath;const e=await fetch(t.webPath);if(e.ok){const s=await e.blob(),k=new File([s],"foto.jpg");return(await U(k,w.value)).objetos}}}catch(t){console.error("[ERROR AL TOMAR LA SELFIE] :",t)}},$=async t=>{try{const e=await F("/registrar_entrada",{},JSON.parse(JSON.stringify({employee_id:t})));e.error==="N"&&(D.value=!0,T.value="Registro de entrada: '"+O+"'"),m.notify({color:e.error==="N"?"green-4":"red-5",textColor:"white",icon:e.error==="N"?"cloud_done":"warning",message:e.mensaje,timeout:1e4})}catch(e){console.error("Error registrando las coordenadas:",e)}},G=async()=>{if((await q.checkPermissions()).coarseLocation==="granted"){const e=await q.getCurrentPosition();v.value.latitude=e.coords.latitude,v.value.longitude=e.coords.longitude,v.value.timestamp=e.timestamp}else m.notify({color:"red-5",textColor:"white",icon:"warning",message:"\xA1Debe chequear los permisos de gps en las configuraciones!"})},H=()=>{r.value&&(b(),r.value=!1)},A=async()=>(await fe.getId()).identifier;j(async()=>{document.addEventListener("backbutton",H),h.value=await A()});const J=async()=>{h.value=await A(),(await N("/validar_dispositivo",{id:h.value})).error==="N"?y.value=!0:(m.notify({color:"red-5",textColor:"white",icon:"warning",message:"\xA1No se encuentra el dispositivo registrado en el sistema!",timeout:1e4}),y.value=!1)},M=ee(()=>r.value?"posiciona el c\xF3digo QR en el centro de la pantalla":"Presiona el bot\xF3n y escanea el c\xF3digo QR"),z=async()=>(await i.checkPermission()).denied?(confirm("Si desea otorgar permiso para usar su c\xE1mara, habil\xEDtelo en la configuraci\xF3n de la aplicaci\xF3n.")&&i.openAppSettings(),!1):!0;(()=>{i.prepare()})();const Y=async()=>{if(J(),!await z())return;await G(),r.value=!0,await i.checkPermission({force:!0}),i.hideBackground();const e=await i.startScan();e.hasContent&&(r.value=!1,x.value=e.content,await K(x.value),p.value=ye(v.value.latitude,v.value.longitude,Q.value,L.value),p.value<=f&&y.value===!0&&(B.value=await V(),B.value===!0?(await $(w.value),D.value==!0&&(P.value=new Date().toLocaleTimeString(),c.value=!0)):c.value=!1),m.notify({color:p.value<=f?"green-4":"red-5",textColor:"white",icon:p.value<=f?"cloud_done":"warning",message:p.value<=f?"El dispositivo est\xE1 dentro del rango especificado.":"El dispositivo est\xE1 fuera del rango especificado.",timeout:1e4}))},b=()=>{i.showBackground(),i.stopScan()};te(()=>{b()}),ae(()=>{b()});const Q=o(0),L=o(0),p=o(0),K=async t=>{const e=await N("/obtener_coordenadas_almacen",{alm_nomcom:t});if(e.error==="N"){const s=e.objetos[0];Q.value=s.lat,L.value=s.long}else{console.error(e.mensaje);return}};return(t,e)=>(n(),oe(de,null,{default:C(()=>[xe,r.value?(n(),l("div",be,Ce)):u("",!0),r.value?u("",!0):(n(),l("h4",Se,Ee)),a("div",Pe,[!r.value&&!c.value?(n(),l("div",De,Ne)):u("",!0),c.value?(n(),l("div",Fe,[a("img",{src:E.value,alt:"Foto tomada",style:{width:"150px"}},null,8,Ae)])):u("",!0)]),a("div",Qe,[a("div",Le,[a("div",null,[c.value?u("",!0):(n(),l("span",je,S(M.value),1))]),c.value?u("",!0):(n(),l("div",Ie,[se(R(ne,{color:"primary",rounded:"",icon:"camera_alt",label:"Escanear c\xF3digo QR",size:"lg",onClick:e[0]||(e[0]=s=>Y())},null,512),[[re,!r.value]])]))])]),c.value?(n(),l("div",qe,[R(ce,{class:"my-card text-white",style:{background:"radial-gradient(circle, #35a2ff 0%, #014a88 100%)"}},{default:C(()=>[R(ie,{class:"q-pa-md"},{default:C(()=>[Te,I(" "+S(P.value)+" ",1),Oe,Ue,I(" "+S(x.value),1)]),_:1})]),_:1})])):u("",!0)]),_:1}))}});var We=W(Ve,[["__scopeId","data-v-5aab067a"]]);export{We as default};
