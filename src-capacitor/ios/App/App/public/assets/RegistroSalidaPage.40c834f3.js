import{U as K,r as o,Q,Y as W,a as X,E as Z,o as ee,_ as n,$ as te,a0 as b,a5 as l,a6 as u,a4 as a,a9 as k,H as ae,at as oe,a1 as S,a2 as se,av as re,a3 as L,au as ne}from"./index.47a28144.js";import{Q as ie}from"./QPage.1664443c.js";import{B as i,G as j,_ as ce}from"./index.a4168823.js";import{C as le,a as ue,b as de,c as me}from"./index.6c2dd6cd.js";import{D as ve}from"./index.c22a573d.js";import{u as ge,a as pe,o as fe}from"./use-quasar.3a6fa932.js";import"./axios.66614422.js";const _e=a("div",{class:"sample-background"},null,-1),he={key:0,class:"container"},we=a("div",{class:"barcode-scanner--area--container"},[a("div",{class:"relative"},[a("p",null,"Apunta tu c\xE1mara al c\xF3digo QR")]),a("div",{class:"square surround-cover"},[a("div",{class:"barcode-scanner--area--outer surround-cover"},[a("div",{class:"barcode-scanner--area--inner"})])])],-1),ye=[we],xe={key:1,class:"row text-uppercase text-grey-8 justify-center items-center content-center q-pa-md text-center",style:{"font-family":"'Bebas Neue'"}},be=a("div",null,"Registrar Salida",-1),ke=[be],Se={class:"column justify-center items-center content-center"},Ce={key:0,class:"col-12 text-center q-pt-md"},Re=a("img",{alt:"QR code",src:ce,style:{width:"340px"}},null,-1),Pe=[Re],Ee={key:1,class:"col-12"},De=["src"],Ne={class:"row justify-center q-pt-lg"},Be={class:"col text-center"},Fe={key:0,class:"text-subtitle2 text-grey-9"},Qe={key:0},Le={key:2,class:"q-pa-md row justify-center items-start q-gutter-md"},je=a("strong",null,"Hora de salida: ",-1),qe=a("br",null,null,-1),Ae=a("strong",null,"Lugar de trabajo: ",-1),p=30,Me=K({__name:"RegistroSalidaPage",setup(Te){const f=o(""),C=o(),R=o(""),q=o(""),_=o(0),d=ge(),h=o(!1),P=o(!1),E=o(!1),w=o(""),c=o(!1),r=o(!1),{get:D,put:A,post:T}=pe();let I=new Date().toLocaleTimeString();const m=o({latitude:0,longitude:0,timestamp:0});Q(()=>{const t=W.getItem("session");_.value=(t==null?void 0:t.codigo)||0});const O=async(t,e)=>{try{const s=new FormData;s.append("file",t);const x=`/comparar_fotos/${e}`,g=await T(x,{},s);return d.notify({color:g.error==="N"?"green-4":"red-5",textColor:"white",icon:g.error==="N"?"cloud_done":"warning",message:g.mensaje,timeout:1e4}),g}catch(s){console.error("[ERROR AL SUBIR LA FOTO]:",s)}},U=async()=>{try{const t=await le.getPhoto({quality:90,allowEditing:!1,resultType:ue.Uri,source:de.Camera,direction:me.Front,width:1024,height:768});if(t.webPath){C.value=t.webPath;const e=await fetch(t.webPath);if(e.ok){const s=await e.blob(),x=new File([s],"foto.jpg");return(await O(x,_.value)).objetos}}}catch(t){console.error("[ERROR AL TOMAR LA SELFIE] :",t)}},V=async()=>{f.value=await N(),(await D("/validar_dispositivo",{id:f.value})).error==="N"?h.value=!0:(d.notify({color:"red-5",textColor:"white",icon:"warning",message:"\xA1No se encuentra el dispositivo registrado en el sistema!",timeout:1e4}),h.value=!1)},$=async t=>{try{const e=await A("/registrar_salida",{},JSON.parse(JSON.stringify({employee_id:t})));e.error==="N"&&(P.value=!0,q.value="Registro de salida: '"+I+"'"),d.notify({color:e.error==="N"?"green-4":"red-5",textColor:"white",icon:e.error==="N"?"cloud_done":"warning",message:e.mensaje,timeout:1e4})}catch(e){console.error("Error registrando las coordenadas:",e)}},G=async()=>{if((await j.checkPermissions()).coarseLocation==="granted"){const e=await j.getCurrentPosition();m.value.latitude=e.coords.latitude,m.value.longitude=e.coords.longitude,m.value.timestamp=e.timestamp}else d.notify({color:"red-5",textColor:"white",icon:"warning",message:"\xA1Debe chequear los permisos de gps en las configuraciones!",timeout:1e4})},H=()=>{r.value&&(y(),r.value=!1)},N=async()=>(await ve.getId()).identifier;Q(async()=>{document.addEventListener("backbutton",H),f.value=await N()});const J=X(()=>r.value?"posiciona el c\xF3digo QR en el centro de la pantalla":"Presiona el bot\xF3n y escanea el c\xF3digo QR"),M=async()=>(await i.checkPermission()).denied?(confirm("Si desea otorgar permiso para usar su c\xE1mara, habil\xEDtelo en la configuraci\xF3n de la aplicaci\xF3n.")&&i.openAppSettings(),!1):!0;(()=>{i.prepare()})();const z=async()=>{if(V(),!await M())return;await G(),r.value=!0,await i.checkPermission({force:!0}),i.hideBackground();const e=await i.startScan();e.hasContent&&(r.value=!1,w.value=e.content,await Y(w.value),v.value=fe(m.value.latitude,m.value.longitude,B.value,F.value),v.value<=p&&h.value===!0&&(E.value=await U(),E.value===!0&&(await $(_.value),P.value==!0?(R.value=new Date().toLocaleTimeString(),c.value=!0):c.value=!1)),d.notify({color:v.value<=p?"green-4":"red-5",textColor:"white",icon:v.value<=p?"cloud_done":"warning",message:v.value<=p?"El dispositivo est\xE1 dentro del rango especificado.":"El dispositivo est\xE1 fuera del rango especificado.",timeout:1e4}))},y=()=>{i.showBackground(),i.stopScan()};Z(()=>{y()}),ee(()=>{y()});const B=o(0),F=o(0),v=o(0),Y=async t=>{const e=await D("/obtener_coordenadas_almacen",{alm_nomcom:t});if(e.error==="N"){const s=e.objetos[0];B.value=s.lat,F.value=s.long}else{console.error(e.mensaje);return}};return(t,e)=>(n(),te(ie,null,{default:b(()=>[_e,r.value?(n(),l("div",he,ye)):u("",!0),r.value?u("",!0):(n(),l("h4",xe,ke)),a("div",Se,[!r.value&&!c.value?(n(),l("div",Ce,Pe)):u("",!0),c.value?(n(),l("div",Ee,[a("img",{src:C.value,alt:"Foto tomada",style:{width:"150px"}},null,8,De)])):u("",!0)]),a("div",Ne,[a("div",Be,[a("div",null,[c.value?u("",!0):(n(),l("span",Fe,k(J.value),1))]),c.value?u("",!0):(n(),l("div",Qe,[ae(S(se,{color:"primary",rounded:"",icon:"camera_alt",label:"Escanear c\xF3digo QR",size:"lg",onClick:e[0]||(e[0]=s=>z())},null,512),[[oe,!r.value]])]))])]),c.value?(n(),l("div",Le,[S(ne,{class:"my-card text-white",style:{background:"radial-gradient(circle, #35a2ff 0%, #014a88 100%)"}},{default:b(()=>[S(re,{class:"q-pa-md"},{default:b(()=>[je,L(" "+k(R.value)+" ",1),qe,Ae,L(" "+k(w.value),1)]),_:1})]),_:1})])):u("",!0)]),_:1}))}});export{Me as default};
